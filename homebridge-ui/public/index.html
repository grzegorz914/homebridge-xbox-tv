<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xbox Authorization Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
</head>

<div class="container mt-3">
  <div class="text-center">
    <img src="homebridge-xbox-tv.png" alt="Image" height="120" />
  </div>

  <div id="authorizationManager" class="card card-body mt-2">
    <form id="configForm">
      <div class="text-center">
        <label id="deviceName" class="fw-bold" style="font-size: 23px;">Xbox</label><br>
        <label id="info" class="d-block" style="font-size: 17px;"></label>
        <label id="info1" class="d-block" style="font-size: 15px;"></label>
      </div>

      <div class="mb-2">
        <label for="deviceHost" class="form-label">Host</label>
        <input id="deviceHost" type="text" class="form-control" required>
      </div>

      <div class="mb-2 position-relative">
        <label for="deviceLiveId" class="form-label">Xbox Live ID</label>
        <div class="input-group">
          <input id="deviceLiveId" type="password" class="form-control" autocomplete="new-password" required>
          <button type="button" id="toggleLiveId" class="btn btn-outline-secondary">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <div class="mb-2 position-relative">
        <label for="deviceToken" class="form-label">Web API Token</label>
        <div class="input-group">
          <input id="deviceToken" type="password" class="form-control" autocomplete="new-password" required>
          <button type="button" id="toggleToken" class="btn btn-outline-secondary">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <div class="form-check mb-2">
        <input id="deviceWebApiControl" type="checkbox" class="form-check-input">
        <label for="deviceWebApiControl" class="form-check-label">Web API Control</label>
      </div>

      <div class="text-center">
        <button id="startAuthorizationButton" type="button" class="btn btn-primary">Start Authorization</button>
        <button id="clearTokenButton" type="button" class="btn btn-secondary">Clear Web API Token</button>
        <button id="configButton" type="button" class="btn btn-secondary"><i class="fas fa-gear"></i></button>
      </div>
    </form>
    <div id="consoleButton" class="d-flex flex-wrap justify-content-center gap-1 mt-3"></div>
  </div>
</div>

<script>
  (async () => {
    const pluginConfig = await homebridge.getPluginConfig();

    if (!pluginConfig.length) {
      pluginConfig.push({});
      await homebridge.updatePluginConfig(pluginConfig);
      homebridge.showSchemaForm();
      return;
    }

    this.deviceIndex = 0;
    const devices = pluginConfig[0].devices || [];
    const devicesCount = devices.length;

    // Helper to get DOM elements
    const $ = id => document.getElementById(id);

    // Helper to set button classes
    const setButtonClass = (activeIndex) => {
      for (let j = 0; j < devicesCount; j++) {
        $(`button${j}`).className = j === activeIndex ? "btn btn-primary" : "btn btn-secondary";
      }
    };

    // Helper to update the device form
    const updateDeviceForm = (device) => {
      $('deviceName').innerHTML = device.name || '';
      $('deviceHost').value = device.host || '';
      $('deviceLiveId').value = device.xboxLiveId || '';
      $('deviceToken').value = device.webApi.token || '';
      $('deviceWebApiControl').checked = device.webApi.enable || false;

      const tokenLength = device.webApi.token?.length || 0;
      $('startAuthorizationButton').innerText = tokenLength <= 10 ? "Start Authorization" : "Check State";
      $('deviceWebApiControl').disabled = tokenLength <= 10;

      if (tokenLength <= 10) {
        $('deviceWebApiControl').checked = false;
        device.webApi.enable = false;
      }
    };

    // Create buttons for each device
    const container = document.getElementById("consoleButton");
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    container.style.justifyContent = 'center';
    container.style.gap = '0.25rem';

    devices.forEach((device, i) => {
      const button = document.createElement("button");
      button.type = "button";
      button.id = `button${i}`;
      button.className = "btn btn-primary";
      button.style.textTransform = 'none';
      button.innerText = device.name || `Device ${i + 1}`;
      container.appendChild(button);

      button.addEventListener("click", async () => {
        setButtonClass(i);
        updateDeviceForm(devices[i]);
        this.deviceIndex = i;
      });

      // Auto-select the first device
      if (i === devicesCount - 1) {
        $("button0").click();
      }
    });

    // Show the authorization form
    $("authorizationManager").style.display = "block";

    // Config button toggle
    let configButtonState = false;
    $("configButton").addEventListener("click", () => {
      configButtonState = !configButtonState;
      homebridge[configButtonState ? 'showSchemaForm' : 'hideSchemaForm']();
      configButton.className = configButtonState ? 'btn btn-primary' : 'btn btn-secondary';
    });

    // Token toggle
    $("toggleLiveId").addEventListener("click", () => {
      const liveIdInput = $("deviceLiveId");
      const icon = document.querySelector('#toggleLiveId i');

      if (liveIdInput.type === 'password') {
        liveIdInput.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        liveIdInput.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    });

    // Token toggle
    $("toggleToken").addEventListener("click", () => {
      const tokenInput = $("deviceToken");
      const icon = document.querySelector('#toggleToken i');

      if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        tokenInput.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    });

    // Update config on form input
    $("configForm").addEventListener("input", async () => {
      const currentDevice = devices[this.deviceIndex];

      currentDevice.host = $('deviceHost').value;
      currentDevice.xboxLiveId = $('deviceLiveId').value;
      currentDevice.webApi.token = $('deviceToken').value;
      currentDevice.webApi.enable = $('deviceWebApiControl').checked;

      const tokenLength = currentDevice.webApi.token?.length || 0;
      $('startAuthorizationButton').innerText = tokenLength <= 10 ? "Start Authorization" : "Check State";

      if (tokenLength <= 10) {
        $('startAuthorizationButton').removeAttribute('disabled');
      }

      await homebridge.updatePluginConfig(pluginConfig);
      await homebridge.savePluginConfig(pluginConfig);
    });

    function updateInfo(id, text, color) {
      const el = document.getElementById(id);
      if (el) {
        el.innerText = text;
        el.style.color = color;
      }
    }

    // Clear token button logic
    $("clearTokenButton").addEventListener("click", async () => {
      updateInfo('info', 'Start clearing token...', 'yellow');
      homebridge.showSpinner();

      try {
        const host = devices[this.deviceIndex].host;
        await homebridge.request('/clearToken', { host });

        Object.assign(devices[this.deviceIndex], {
          webApi: {
            token: '',
            enable: false
          }
        });

        updateDeviceForm(devices[this.deviceIndex]);
        updateInfo('info', "Web API token cleared, now you can start a new authorization process.", "green");
        $("startAuthorizationButton").removeAttribute("disabled");

        await homebridge.updatePluginConfig(pluginConfig);
        await homebridge.savePluginConfig(pluginConfig);
      } catch (error) {
        updateInfo('info', "Clear Web API token error.", "yellow");
        updateInfo('info1', `Error: ${error}`, "red");
      } finally {
        homebridge.hideSpinner();
      }
    });

    // Start authorization logic
    $("startAuthorizationButton").addEventListener("click", async () => {
      homebridge.showSpinner();
      $("startAuthorizationButton").setAttribute("disabled", "true"); // blokada wielokliku
      updateInfo('info', "Starting authorization...", "yellow");

      try {
        const device = devices[this.deviceIndex];
        const { host, webApi } = device;
        const { token, clientId, clientSecret } = webApi;

        const response = await homebridge.request('/startAuthorization', {
          host, token, clientId, clientSecret
        });

        const { info, status } = response;

        switch (status) {
          case 0: // Authorized
            updateInfo('info', info, "green");
            $("startAuthorizationButton").innerText = "Check State";
            $("deviceWebApiControl").disabled = false;
            break;
          case 1: // Needs user interaction
            $("startAuthorizationButton").innerText = "Activate Console";
            $("deviceWebApiControl").checked = false;
            $("deviceWebApiControl").disabled = true;
            device.webApi.enable = false;

            let timeLeft = 10;
            const timerId = setInterval(() => {
              if (timeLeft <= 0) {
                open(info);
                clearInterval(timerId);
                updateInfo('info', "Now paste the *code* into *Web API Token* and press *Activate Console*.", "yellow");
              } else {
                updateInfo('info', `After ${timeLeft} sec, sign in to Xbox Live and authorize. Then copy the code after ?code= and return here.`, "yellow");
                timeLeft--;
              }
            }, 1000);
            break;
          case 2: // Successfully authorized
            updateInfo('info', info, "green");
            $("startAuthorizationButton").innerText = "Check State";
            $("deviceWebApiControl").disabled = false;
            $("deviceWebApiControl").checked = true;
            device.webApi.enable = true;

            await homebridge.updatePluginConfig(pluginConfig);
            await homebridge.savePluginConfig(pluginConfig);
            break;
        }
      } catch (error) {
        updateInfo('info', "Authorization error.", "yellow");
        updateInfo('info1', `Error: ${JSON.stringify(error)}`, "red");
      } finally {
        $("startAuthorizationButton").removeAttribute("disabled");
        homebridge.hideSpinner();
      }
    });

  })();
</script>